```{r load_libraries}

devtools::load_all()

library(tidymodels)

library(tidyverse)

library(glue)

library(skimr)

library(corrr)

```

```{r load_data}

data("train_set")

train_set = train_set %>% 
  rename(target = serious_dlqin_2yrs) %>% 
  # mutate(across(where(~length(unique(.)) < 2), as.factor)) %>% 
  identity()

```


```{r preprocess_data}

preprocess_recipe = recipe(formula = target ~ ., data = train_set) %>%
  step_filter(monthly_income >= 1000) %>% 
  step_mutate_at(c("monthly_income", "debt_ratio"),
                 fn = ~ DescTools::Winsorize(., probs = c(0,0.95), na.rm = TRUE)) %>% 
  step_mutate_at(c("monthly_income", "debt_ratio"),
                 fn = ~ log(.))

train_set_transformed = preprocess_recipe %>% 
  prep() %>% 
  bake(train_set)

```

## Missing values

```{r plot_missing}

train_set %>% 
  pivot_longer(everything()) %>% 
  group_by(name) %>% 
  summarise(na_share = sum(is.na(value)) / length(value), .groups = "drop") %>% 
  ggplot(aes(x = reorder(name, na_share), y = na_share)) + 
  geom_col() + 
  ylab(NULL) + xlab(NULL) + ggtitle("Missing values share") + 
  scale_y_continuous(labels = scales::percent_format()) + 
  coord_flip()

```

We can see that about 20% of monthly income is missing. we should try to impute the
missing data because it seems costly to drop 20%.

```{r impute_income}



```

## Numeric features


```{r boxplot}

train_set %>% 
  pivot_longer(-target) %>% 
  ggplot(aes(y = value, fill = target)) + 
  geom_boxplot() + 
  facet_wrap(~name)

```

```{r desc_stats}

skim(train_set)

```


The "count" variables are characterized by outliers, I'll leave them untransformed.

```{r count_features}

train_set %>% 
  select(starts_with("number")) %>% 
  pivot_longer(everything()) %>% 
  ggplot(aes(x = value)) + 
  geom_histogram() + 
  facet_wrap(~name, scales = "free")
```

winsorizing at 95% and then log transforming the income and debt seems to "balance" the skewness

```{r income_and_debt_ratio}

train_set %>% 
  filter(monthly_income >= 1000) %>% 
  select(monthly_income, debt_ratio) %>% 
  mutate(across(everything(), ~DescTools::Winsorize(., probs = c(0,0.95)))) %>% 
  pivot_longer(everything()) %>%
  ggplot(aes(x = log(value))) + 
  geom_histogram() + 
  facet_wrap(~name, scales = "free") + 
  ggtitle("Histogram of log transformed features")

```


### features

\code{revolving_utilization_of_unsecured_lines} - this feature is defined as the ratio of used credit (balance on credit cards and no installment debt like car loans) to total credit limits. This feature shouldn't be larger than 1, checking for right tail we see that `glue(round((ecdf(train_set$revolving_utilization_of_unsecured_lines)(1)) * 100,1),"%")` are in the proper range. We can divide the feature to 3 groups: 
norm(below 1), med(between 1 and 10) and hign(above 10). We can see that we have about 2% of the obs in the med groups and insignificant number (few dozens) in high group. We can see that in the normal group higher values means more default and in "outlier" groups this is the other way around.


```{r revolving_utilization_of_unsecured_lines_tail}

train_set %>%
  mutate(ind = case_when(revolving_utilization_of_unsecured_lines < 1 ~ "norm",
                         revolving_utilization_of_unsecured_lines < 10 ~ "med",
                         revolving_utilization_of_unsecured_lines > 10 ~ "high")) %>% 
  mutate(ind = factor(ind, levels = c("norm","med","high"))) %>% 
  ggplot(aes(x = revolving_utilization_of_unsecured_lines, fill = as_factor(target))) + 
  geom_histogram() + 
  facet_wrap(~ind, scales = "free")

```

\code{number_of_dependents} - this feature specifies the number of dependents 
excluding the borrower (spouse, children, etc)

```{r number_of_dependents}

train_set %>%
  select(target, number_of_dependents) %>% 
  filter(complete.cases(.)) %>% 
  mutate(ind = case_when(number_of_dependents <= 5 ~ "norm",
                         number_of_dependents > 5 ~ "outliers")) %>% 
  mutate(ind = factor(ind, levels = c("norm","outliers"))) %>% 
  ggplot(aes(x = as.factor(number_of_dependents), fill = as_factor(target))) + 
  geom_histogram(position = "dodge",stat = "count") + 
  facet_wrap(~ind, scales = "free") + 
  xlab("Number of dependents") + 
  labs(fill = "Target")

```




```{r boxplot_transformed}

train_set_transformed %>% 
  pivot_longer(-target) %>% 
  ggplot(aes(y = value, fill = as.factor(target))) + 
  geom_boxplot() + 
  facet_wrap(~name, scales = "free")

```

We can see that all the features have outliers


```{r class_balance}

train_set %>% 
  count(target) %>% 
  mutate(n = n / sum(n)) %>% 
  ggplot(aes(x = factor(target), y = n, fill = factor(target))) + 
  geom_col() + 
  scale_y_continuous(labels = scales::percent_format()) + 
  scale_fill_viridis_d() + 
  labs(fill = "Target") + 
  xlab(NULL) + ylab(NULL) + ggtitle("Target class is unbalanced")


```

```{r correlation}

train_set %>% 
  correlate() %>% 
  stretch() %>% 
  filter(y == "target") %>% 
  filter(complete.cases(.)) %>% 
  ggplot(aes(x = reorder(x,r), y = r)) + 
  geom_col() + 
  coord_flip() + 
  xlab(NULL) + ylab(NULL)

```

We can see that "missing payments" features are positively correlated, monthly income and
age is negatively correlated. Interestingly the number of open credit lines is also negatively correlated.

```{r open_credit_lines}

train_set %>% 
  filter(number_of_open_credit_lines_and_loans < 10) %>%
  count(number_of_open_credit_lines_and_loans, target) %>% 
  group_by(number_of_open_credit_lines_and_loans) %>% 
  mutate(n = n / sum(n)) %>%
  mutate(target = factor(target)) %>% 
  ggplot(aes(x = number_of_open_credit_lines_and_loans, y = n, fill = target)) + 
  geom_col() + 
  scale_y_continuous(labels = scales::percent_format()) + 
  ggtitle("The proportion of defaults is higher in low number of credit lines")



```



```{r density_plots}

train_set_transformed %>% 
  pivot_longer(-target) %>% 
  ggplot(aes(x = value, fill = factor(target))) + 
  geom_density() + 
  facet_wrap(~name, scales = "free")
  

```

