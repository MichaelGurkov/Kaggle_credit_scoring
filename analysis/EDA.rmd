```{r load_libraries}

devtools::load_all()

library(tidymodels)

tidymodels_prefer()

library(tidyverse)

library(glue)

library(skimr)

library(corrr)

```

```{r load_data}

data("train_set")

data("names_table")

train_set = train_set %>% 
  rename_at(names_table$full_name, ~names_table$feature_name)

```



```{r preprocess_data}

preprocess_recipe = recipe(formula = target ~ ., data = train_set) %>%
  step_mutate(target = factor(target, levels = c(1, 0))) %>%
  step_impute_median("dependents")  %>%
  step_impute_median("income") %>% 
  step_filter(income >= 1000) %>%
  step_mutate_at(c("income", "debt_ratio", "ruul"),
                 fn = ~ DescTools::Winsorize(., probs = c(0, 0.95),
                                             na.rm = TRUE)) %>% 
  step_mutate(debt_log = (log(debt_ratio * income + 1))) %>% 
  step_center(contains("due")) %>% 
  identity()


train_set_transformed = preprocess_recipe %>% 
  prep(training = train_set) %>% 
  bake(new_data = NULL)

```

# Raw data analysis

## Missing values

```{r plot_missing}

train_set %>% 
  pivot_longer(everything()) %>% 
  group_by(name) %>% 
  summarise(na_share = sum(is.na(value)) / length(value), .groups = "drop") %>% 
  ggplot(aes(x = reorder(name, na_share), y = na_share)) + 
  geom_col() + 
  ylab(NULL) + xlab(NULL) + ggtitle("Missing values share") + 
  scale_y_continuous(labels = scales::percent_format()) + 
  coord_flip()

```

We can see that about 20% of monthly income is missing. we should try to impute the missing data because it seems costly to drop 20%.

## Numeric features


```{r histogram}

train_set %>% 
  pivot_longer(-target) %>% 
  ggplot(aes(x = value, fill = target)) + 
  geom_histogram() + 
  facet_wrap(~name, scales = "free")

```


```{r boxplot}

train_set %>% 
  pivot_longer(-target) %>% 
  ggplot(aes(y = value, fill = target)) + 
  geom_boxplot() + 
  facet_wrap(~name, scales = "free")

```

```{r desc_stats}

skim(train_set)

```


The "count" variables are characterized by outliers, I'll leave them untransformed.

```{r count_features}

train_set %>% 
  select(starts_with("number")) %>% 
  pivot_longer(everything()) %>% 
  ggplot(aes(x = value)) + 
  geom_histogram() + 
  facet_wrap(~name, scales = "free")
```

### Income and debt ratio

```{r high_debt}

income_debt_outliers = train_set %>% 
  select(debt_ratio, income) %>% 
  filter(debt_ratio >= quantile(debt_ratio, 0.95))
  

income_debt_outliers %>% 
  mutate(debt = debt_ratio * income) %>% 
  filter(debt <= quantile(debt,0.90, na.rm = TRUE)) %>%
  ggplot(aes(x = debt)) + 
  geom_histogram()


```




winsorizing at 95% and then log transforming the income and debt seems to improve the skewness

```{r income_and_debt_ratio}

train_set %>% 
  filter(monthly_income >= 1000) %>% 
  select(monthly_income, debt_ratio) %>% 
  mutate(across(everything(), ~DescTools::Winsorize(., probs = c(0,0.95)))) %>% 
  pivot_longer(everything()) %>%
  ggplot(aes(x = log(value))) + 
  geom_histogram() + 
  facet_wrap(~name, scales = "free") + 
  ggtitle("Histogram of log transformed features")

```


### features

\code{revolving_utilization_of_unsecured_lines} - this feature is defined as the ratio of used credit (balance on credit cards and no installment debt like car loans) to total credit limits. This feature shouldn't be larger than 1, checking for right tail we see that `glue(round((ecdf(train_set$revolving_utilization_of_unsecured_lines)(1)) * 100,1),"%")` are in the proper range. We can divide the feature to 3 groups: 
norm(below 1), med(between 1 and 10) and hign(above 10). We can see that we have about 2% of the obs in the med groups and insignificant number (few dozens) in high group. We can see that in the normal group higher values means more default and in "outlier" groups this is the other way around. I winsorize the upper 5% of this feature - this improves it's roc_auc contribution.


```{r revolving_utilization_of_unsecured_lines_tail}

train_set %>%
  mutate(ind = case_when(ruul < 1 ~ "norm",
                         ruul < 10 ~ "med",
                         ruul > 10 ~ "high")) %>%
  mutate(ind = factor(ind, levels = c("norm", "med", "high"))) %>%
  ggplot(aes(x = ruul, fill = as_factor(target))) +
  geom_histogram() +
  facet_wrap(~ ind, scales = "free")

```

\code{number_of_dependents} - this feature specifies the number of dependents 
excluding the borrower (spouse, children, etc)

```{r number_of_dependents}

train_set %>%
  select(target, number_of_dependents) %>% 
  filter(complete.cases(.)) %>% 
  mutate(ind = case_when(number_of_dependents <= 5 ~ "norm",
                         number_of_dependents > 5 ~ "outliers")) %>% 
  mutate(ind = factor(ind, levels = c("norm","outliers"))) %>% 
  ggplot(aes(x = as.factor(number_of_dependents), fill = as_factor(target))) + 
  geom_histogram(position = "dodge",stat = "count") + 
  facet_wrap(~ind, scales = "free") + 
  xlab("Number of dependents") + 
  labs(fill = "Target")

```

\code{number_of_open_credit_lines_and_loans} - this feature describes the number of open loans (installment like car loan or mortgage) and lines of credit (e.g. credit cards)


```{r number_of_open_credit_lines_and_loans}

train_set %>% 
  count(number_of_open_credit_lines_and_loans) %>% 
  mutate(ind = case_when(number_of_open_credit_lines_and_loans <= 20 ~ "norm",
                         number_of_open_credit_lines_and_loans > 20 ~ "outliers")) %>% 
  ggplot(aes(x = number_of_open_credit_lines_and_loans, y = n)) + 
  geom_col() + 
  ylab(NULL) + ggtitle("Distribution of open credit lines") + 
  facet_wrap(~ind, scales = "free")

```

About `glue(round((ecdf(train_set$number_of_open_credit_lines_and_loans)(20)) * 100,1),"%")` of open credit lines are less than 20.

\code{number_real_estate_loans_or_lines} - this feature describes the number of mortgage and real estate loans including home equity lines of credit.


```{r number_real_estate_loans_or_lines}

train_set %>% 
  count(number_real_estate_loans_or_lines) %>% 
  mutate(ind = case_when(number_real_estate_loans_or_lines <= 10 ~ "norm",
                         number_real_estate_loans_or_lines > 10 ~ "outliers")) %>%
  ggplot(aes(x = number_real_estate_loans_or_lines, y = n)) + 
  geom_col() + 
  ylab(NULL) + ggtitle("Distribution of real estate loans") + 
  facet_wrap(~ind, scales = "free") +
  NULL

```

About `glue(round((ecdf(train_set$number_real_estate_loans_or_lines)(5)) * 100,1),"%")` of open credit lines are less than 5.


\code{age} - younger people default more

```{r age}

train_set %>% 
  ggplot(aes(x = age, fill = as.factor(target))) + 
  geom_histogram(alpha = 0.8) + 
  ylab(NULL) + ggtitle("Distribution of real estate loans") +
  NULL

```


```{r binned_age}

train_set %>% 
  mutate(age_binned = cut(age,breaks = seq(0,110,10),
                          labels = seq(0,110,10)[-1])) %>% 
  count(age_binned, target) %>% 
  group_by(age_binned) %>% 
  mutate(prop = n / sum(n)) %>% 
  ggplot(aes(x = age_binned, y = prop, fill = as_factor(target))) + 
  geom_col() + 
  scale_y_continuous(labels = scales::percent_format()) + 
  xlab(NULL) + ggtitle("Age by groups")

```


\code{debt_ratio} - the ratio between monthly payments and monthly income 

```{r debt_ratio}

train_set %>% 
  mutate(ind = case_when(debt_ratio < 1 ~ "norm",
                         debt_ratio <= 100 ~ "med",
                         debt_ratio > 100 ~ "high")) %>%
  mutate(ind = factor(ind, levels = c("norm", "med", "high"))) %>% 
  ggplot(aes(x = debt_ratio, fill = as.factor(target))) + 
  geom_histogram(alpha = 0.8) + 
  facet_wrap(~ind, scales = "free") + 
  ylab(NULL) + ggtitle("Distribution of debt ratio") +
  theme(legend.title = element_blank()) + 
  NULL

```


## Summary

* winsorize (at 95%) and log transform income and debt ratio

* maybe deal with outliers


### Average customer

```{r  average_values_plot}

average_df = train_set_transformed %>% 
  group_by(target) %>% 
  summarise(across(everything(),
                   .fns = list(AAAmean = mean, AAAmedian = median),
                   na.rm = TRUE)) 

average_df_long  = average_df %>% 
  pivot_longer(-target) %>% 
  separate(name, into = c("name","fun"),sep = "_AAA")

ggplot() + 
  geom_point(data = average_df_long %>% 
               filter(fun == "mean"),
             aes(x = target, y = value, color = target), size = 3) + 
  geom_col(data = average_df_long %>% 
             filter(fun == "median"),
           aes(x = target, y = value, fill = target), width = 0.5, alpha = 0.5) + 
  facet_wrap(~name, scales = "free") + 
  xlab(NULL) + ylab(NULL) + ggtitle("Average feature values by target")

rm(average_df_long)

```



```{r boxplot_transformed}

train_set_transformed %>% 
  pivot_longer(-target) %>% 
  ggplot(aes(y = value, fill = as.factor(target))) + 
  geom_boxplot() + 
  facet_wrap(~name, scales = "free")

```

We can see that all the features have outliers


```{r class_balance}

train_set %>% 
  count(target) %>% 
  mutate(n = n / sum(n)) %>% 
  ggplot(aes(x = factor(target), y = n, fill = factor(target))) + 
  geom_col() + 
  scale_y_continuous(labels = scales::percent_format()) + 
  scale_fill_viridis_d() + 
  labs(fill = "Target") + 
  xlab(NULL) + ylab(NULL) + ggtitle("Target class is unbalanced")


```


```{r correlation}

train_set %>% 
  correlate() %>% 
  stretch() %>% 
  filter(y == "target") %>% 
  filter(complete.cases(.)) %>% 
  ggplot(aes(x = reorder(x,r), y = r)) + 
  geom_col() + 
  coord_flip() + 
  xlab(NULL) + ylab(NULL)

```

We can see that "missing payments" features are positively correlated, monthly income and age is negatively correlated. Interestingly the number of open credit lines is also negatively correlated.

```{r open_credit_lines}

train_set %>% 
  filter(number_of_open_credit_lines_and_loans < 10) %>%
  count(number_of_open_credit_lines_and_loans, target) %>% 
  group_by(number_of_open_credit_lines_and_loans) %>% 
  mutate(n = n / sum(n)) %>%
  mutate(target = factor(target)) %>% 
  ggplot(aes(x = number_of_open_credit_lines_and_loans, y = n, fill = target)) + 
  geom_col() + 
  scale_y_continuous(labels = scales::percent_format()) + 
  ggtitle("The proportion of defaults is higher in low number of credit lines")



```



```{r density_plots}

train_set_transformed %>% 
  pivot_longer(-target) %>% 
  ggplot(aes(x = value, fill = factor(target))) + 
  geom_density() + 
  facet_wrap(~name, scales = "free")
  

```




# Transformed data analysis

```{r roc_contribution}


roc_auc_df = names(train_set_transformed) %>% 
  enframe() %>% 
  select(temp_var = value) %>% 
  filter(!temp_var == "target")




roc_auc_df = roc_auc_df %>%
  mutate(roc_auc = map(temp_var, function(temp_name) {
    
    temp_resample = workflow() %>%
      add_formula(formula(glue("target ~ ", temp_name))) %>%
      add_model(logistic_reg()) %>%
      fit_resamples(
        resamples = vfold_cv(
          train_set_transformed,
          v = 10,
          repeats = 5,
          strata = target
        ),
        metrics = metric_set(roc_auc)
      )
    
    temp_metrics = temp_resample %>% 
      collect_metrics()

    
    return(temp_metrics)


  }))


roc_auc_df %>% 
  unnest(roc_auc) %>% 
  mutate(mean = mean - 0.5) %>% 
  ggplot() + 
  geom_point(aes(x = reorder(temp_var, mean), y = mean)) + 
  geom_errorbar(aes(x = reorder(temp_var, mean),
                     ymax = mean + std_err, ymin = mean - std_err)) +
  geom_hline(yintercept = 0, linetype = "dashed") + 
  coord_flip() + 
  xlab(NULL) + ylab(NULL) + ggtitle("Feature importance by roc_auc delta")




```


```{r boxplot_transformed}

train_set_transformed %>% 
  mutate(debt_ratio = 1/(debt_ratio + 1)) %>% 
  pivot_longer(-target) %>% 
  ggplot(aes(x = target, y = value, fill = target)) + 
  geom_boxplot() + 
  facet_wrap(~name, scales = "free_y")

```


### Correlations

```{r corelations}

train_set_transformed %>% 
  select(where(is.numeric)) %>% 
  correlate() %>% 
  shave() %>% 
  rplot()


```

### Features

### Income and debt ratio

```{r debt_ratio}

train_set_transformed %>% 
  ggplot(aes(x = target, y = debt_log, fill = as.factor(target))) + 
  geom_boxplot()


```

### "Count" features

```{r count_hist}

train_set_transformed %>% 
  filter(large_due < 1) %>% 
  select(large_due, target) %>% 
  ggplot(aes(x = large_due, fill = as_factor(target))) + 
  geom_histogram()

```

