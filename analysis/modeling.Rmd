
```{r libraries}

library(tidymodels)

library(tidyverse)

library(vip)



```

```{r load_data}

data("names_table")

data("train_set")

data("test_set")


```

```{r split_data}

indices = list(analysis = seq(nrow(train_set)),
               assessment = nrow(train_set) + seq(nrow(test_set)))

comb_data = train_set %>% 
  bind_rows(test_set) %>% 
  rename(target = serious_dlqin_2yrs)

data_split = make_splits(ind = indices, data = comb_data)

rm(indices, test_set, comb_data)

train_set = training(data_split)

train_set = train_set %>% 
  rename_at(names_table$full_name, ~names_table$feature_name)

train_set = train_set %>% 
  slice_sample(n = 1000)

```


```{r}

train_set_transformed = preprocess_recipe %>% 
  prep(training = train_set) %>% 
  bake(new_data = NULL)

```


```{r define_preprocess_recipes}

preprocess_recipe = recipe(formula = target ~ ., data = train_set) %>%
  step_mutate(target = factor(target, levels = c(1, 0)), skip = TRUE) %>%
  step_impute_median("dependents")  %>%
  step_impute_median("income") %>% 
  step_filter(income >= 1000) %>%
  step_mutate_at(c("income", "debt_ratio", "ruul"),
                 fn = ~ DescTools::Winsorize(., probs = c(0, 0.95),
                                             na.rm = TRUE)) %>% 
  step_mutate(debt_log = (log(debt_ratio * income + 1))) %>% 
  step_center(contains("due")) %>% 
  identity()

```

```{r define_models}

logit_mod = logistic_reg() %>% 
  set_engine("glm")

logit_wf = workflow() %>% 
  add_recipe(preprocess_recipe) %>% 
  add_model(logit_mod)


```

```{r cross_validation}

cv_resamples = vfold_cv(v = 10, data = train_set)

logit_resamples = logit_wf %>%
  fit_resamples(cv_resamples)

```

```{r fit_model}

logit_fit = logit_wf %>% 
  fit(train_set)



```

```{r predict}

logit_pred = logit_fit %>% 
  predict(train_set, type = "prob")

```

```{r evaluation}

logit_pred %>% 
  select(estimate = .pred_1) %>% 
  mutate(estimate = as.numeric((estimate > 0.5))) %>% 
  bind_cols(truth = train_set$target) %>% 
  mutate(across(everything(), factor, levels = c(1,0))) %>% 
  conf_mat(estimate = estimate, truth = truth)


logit_pred %>% 
  select(estimate = .pred_1) %>% 
  mutate(estimate = as.numeric((estimate > 0.1))) %>% 
  bind_cols(truth = train_set$target) %>% 
  mutate(across(everything(), factor, levels = c(1,0))) %>% 
  conf_mat(estimate = estimate, truth = truth)

```

```{r plot_roc}

logit_pred %>% 
  select(estimate = .pred_1) %>% 
  bind_cols(truth = train_set$target) %>% 
  mutate(truth = factor(truth, levels = c(1,0))) %>% 
  roc_curve(estimate = estimate, truth = truth) %>% 
  autoplot()


```

