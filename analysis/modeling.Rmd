
```{r libraries}

library(tidymodels)

library(tidyverse)



```

```{r load_data}

data("train_set")

data("test_set")


```

```{r split_data}

indices = list(analysis = seq(nrow(train_set)),
               assessment = nrow(train_set) + seq(nrow(test_set)))

comb_data = train_set %>% 
  bind_rows(test_set) %>% 
  rename(target = serious_dlqin_2yrs)

data_split = make_splits(ind = indices, data = comb_data)

rm(indices, test_set, comb_data)

train_set = training(data_split)

```

```{r define_preprocess_recipes}

preprocess_recipe = recipe(formula = target ~ ., data = train_set) %>%
  update_role("Id",new_role = "ID") %>% 
  step_mutate(target = factor(target, levels = c(1, 0))) %>%
  step_filter(monthly_income >= 1000) %>%
  step_impute_median("number_of_dependents") %>%
  step_mutate_at(
    c("monthly_income", "debt_ratio"),
    fn = ~ DescTools::Winsorize(., probs = c(0, 0.95), na.rm = TRUE)
  ) %>%
  step_mutate_at(c("monthly_income", "debt_ratio"),
                 fn = ~ log(. + 1)) %>%
  step_impute_median("monthly_income") %>%
  step_mutate(age_sqr = age ^ 2) %>% 
  step_normalize(all_predictors())


```

```{r define_models}

lasso_mod = logistic_reg(penalty = tune()) %>% 
  set_engine("glmnet")



```

```{r set_cv_params}

cv_resamples = vfold_cv(v = 10, data = train_set)

grid_spec = grid_regular(penalty(),levels = 10)

```

```{r estimate}


lasso_wf = workflow() %>% 
  add_recipe(preprocess_recipe) %>% 
  add_model(lasso_mod)

lasso_res = lasso_wf %>%
  tune_grid(resamples = cv_resamples,
            grid = grid_spec)

```

```{r plot_results, eval=FALSE}

metrics = lasso_res %>% 
  collect_metrics() %>% 
  filter(.metric == "roc_auc")

ggplot() +
  geom_point(data = metrics, aes(x = penalty, y = mean)) +
  geom_errorbar(data = metrics, aes(
    x = penalty,
    ymin = mean - std_err,
    ymax = mean + std_err
  )) +
  scale_x_log10()

```

```{r forecast}

forecast = lasso_wf %>% 
  finalize_workflow(lasso_res %>%
                select_best("roc_auc")) %>% 
  last_fit(data_split)


forecast_df = forecast %>% 
  collect_predictions()


# forecast_df %>% 
#   mutate(Id = row_number()) %>% 
#   select(Id, Probability = .pred_1) %>% 
#   write_csv("C:\\Users\\Home\\Desktop\\lasso.csv")


```

